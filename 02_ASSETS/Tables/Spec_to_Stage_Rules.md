# قواعد ربط المواصفات بالمراحل (Spec → StagePlan)

## الهدف
توليد StagePlan ديناميكياً لكل عنصر بناءً على المواصفات/الخيارات القادمة من نظام المبيعات، مع منع التكرار وضمان ترتيب المراحل.

## المدخلات
- مصدر المواصفات: `PRODUCTS.CUSTOMER_OPTIONS_JSON`
- (افتراض) جدول مُساعد للفهرسة: `SPEC_OPTIONS(ITEM_ID, SPEC_KEY, SPEC_VALUE)`

## قواعد الإضافة الأساسية
1) **غسيل القماش**
   - إذا كانت المواصفة `washing = true` أو `washing_type` غير فارغ
   - أضف المرحلة `STG-250_WASHING`
   - موضعها: بعد القص وقبل الكبس الأولي (`STG-040_PRESS_PRELIM`)

2) **التطريز**
   - إذا كانت المواصفة `embroidery = true`
   - أضف المرحلة `STG-070_EMBROIDERY`
   - موضعها: بعد القص وقبل الخياطة الرئيسية (`STG-080_SEW_MAIN`)

3) **الإكسسوار**
   - إذا كانت المواصفة `accessories = true`
   - أضف المرحلة `STG-260_ACCESSORIES`
   - موضعها: بعد التحضير (`STG-085_PREP`) وقبل التجميع (`STG-097_BODY_ASSEMBLY`)

## قواعد الترتيب والأولوية
- ترتيب المراحل يعتمد على `SequenceDefault` في `Stages_List.csv`.
- عند إضافة مرحلة جديدة، يتم إدراجها وفق ترتيبها الرقمي مع منع التكرار.
- إذا كانت المرحلة مضافة مسبقاً في المسار الأساسي، لا تُكرر.

## قواعد التعارض
- إذا كان العنصر مخصّصاً لخياطة خارجية (External Tailor):
  - يتم استبدال المراحل الداخلية ذات الصلة بمرحلة `STG-103_SEW_SIDE_EXTERNAL` عند الحاجة.
- لا يُسمح بوجود مرحلتين متعارضتين لنفس الغرض في StagePlan.

## التخزين
- StagePlan يُخزّن في جدول وسيط (افتراض):
  - `ITEM_STAGE_PLAN(ITEM_ID, STAGE_CODE, SEQ, REQUIRED_YN)`
- يتم حفظ نسخة مسار المنتج لحساب ETA والاختناقات.

## المخرجات
- StagePlan كامل لكل عنصر مع سبب الإضافة في السجل (اختياري: `PLAN_REASON`).
